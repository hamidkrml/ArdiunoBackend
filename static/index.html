<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Otopark | Dashboard</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <span class="icon">üöó</span>
                <h2>ParkAI</h2>
            </div>
            <nav>
                <div class="nav-item active" onclick="showTab('dashboard')">üè† Dashboard</div>
                <div class="nav-item" onclick="showTab('users')">üë• Kullanƒ±cƒ±lar</div>
                <div class="nav-item" onclick="showTab('logs')">üìã Eri≈üim Kayƒ±tlarƒ±</div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="content">
            <header>
                <h1>Otopark Y√∂netim Paneli</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openModal()">+ Yeni Ara√ß Ekle</button>
                    <div class="status-badge">Sistem √áevrimi√ßi</div>
                </div>
            </header>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3 id="stat-total-users">0</h3>
                        <p>Kayƒ±tlƒ± Ara√ß</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <h3 id="stat-today-granted">0</h3>
                        <p>Bug√ºnk√º Giri≈ü</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ùå</div>
                    <div class="stat-info">
                        <h3 id="stat-today-denied">0</h3>
                        <p>Yetkisiz Deneme</p>
                    </div>
                </div>
            </div>

            <!-- Charts & Lists Section -->
            <section class="main-sections">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="tab-content active">
                    <div class="card chart-container">
                        <h3>Son 24 Saat Trafik</h3>
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users-tab" class="tab-content">
                    <div class="card">
                        <h3>Kayƒ±tlƒ± Ara√ß Listesi</h3>
                        <div class="table-wrapper">
                            <table id="users-table">
                                <thead>
                                    <tr>
                                        <th>ƒ∞sim</th>
                                        <th>Plaka / Kart ID</th>
                                        <th>Durum</th>
                                        <th>ƒ∞≈ülem</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="logs-tab" class="tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3>Son Giri≈ü √áƒ±kƒ±≈ülar</h3>
                            <div class="card-actions">
                                <button class="btn btn-sm btn-outline-danger" onclick="clearUnauthorizedLogs()">Yetkisizleri Temizle</button>
                                <button class="btn btn-sm btn-danger" onclick="clearAllLogs()">T√ºm√ºn√º Sil</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="logs-table">
                                <thead>
                                    <tr>
                                        <th>Plaka</th>
                                        <th>Sonu√ß</th>
                                        <th>Zaman</th>
                                        <th>Mesaj</th>
                                        <th>ƒ∞≈ülem</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content card">
            <h2>Yeni Ara√ß Kaydet</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label>S√ºr√ºc√º ƒ∞smi</label>
                    <input type="text" id="newName" placeholder="√ñrn: Ahmet Yƒ±lmaz" required>
                </div>
                <div class="form-group">
                    <label>Plaka / Kart ID</label>
                    <input type="text" id="newCardId" placeholder="√ñrn: 34ABC123" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal()">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Tab switching logic
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Modal Functions
        function openModal() { document.getElementById('addUserModal').classList.add('active'); }
        function closeModal() { document.getElementById('addUserModal').classList.remove('active'); }

        // Add User
        document.getElementById('addUserForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('newName').value,
                card_id: document.getElementById('newCardId').value
            };
            
            const res = await fetch('/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                closeModal();
                updateDashboard();
                document.getElementById('addUserForm').reset();
            }
        };

        // Delete User
        async function deleteUser(id) {
            if (confirm('Bu aracƒ± silmek istediƒüinize emin misiniz?')) {
                const res = await fetch(`/admin/users/${id}`, { method: 'DELETE' });
                if (res.ok) updateDashboard();
            }
        }

        // Fetch Data
        async function updateDashboard() {
            try {
                // Fetch Stats
                const stats = await fetch('/admin/stats').then(r => r.json());
                document.getElementById('stat-total-users').innerText = stats.total_users;
                document.getElementById('stat-today-granted').innerText = stats.today_granted;
                document.getElementById('stat-today-denied').innerText = stats.today_denied;

                // Fetch Users
                const users = await fetch('/admin/users').then(r => r.json());
                const userTbody = document.querySelector('#users-table tbody');
                userTbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.name}</td>
                        <td><code>${u.card_id}</code></td>
                        <td><span class="badge ${u.is_active ? 'success' : 'danger'}">${u.is_active ? 'Aktif' : 'Pasif'}</span></td>
                        <td>
                            <button class="btn-icon danger" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

                // Fetch Logs
                const logs = await fetch('/admin/logs').then(r => r.json());
                const logTbody = document.querySelector('#logs-table tbody');
                logTbody.innerHTML = logs.map(l => `
                    <tr>
                        <td><strong>${l.card_id}</strong></td>
                        <td><span class="badge ${l.access_granted ? 'success' : 'danger'}">${l.access_granted ? 'ONAY' : 'RED'}</span></td>
                        <td>${l.timestamp}</td>
                        <td>${l.message || '-'}</td>
                        <td>
                            <button class="btn-icon danger" onclick="deleteLog(${l.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error("Veri √ßekme hatasƒ±:", err);
            }
        }

        // Log Functions
        async function deleteLog(id) {
            if (confirm('Bu log kaydƒ±nƒ± silmek istediƒüinize emin misiniz?')) {
                const res = await fetch(`/admin/logs/${id}`, { method: 'DELETE' });
                if (res.ok) updateDashboard();
            }
        }

        async function clearUnauthorizedLogs() {
            if (confirm('T√ºm YETKƒ∞Sƒ∞Z eri≈üim denemelerini silmek istediƒüinize emin misiniz?')) {
                const res = await fetch('/admin/logs/unauthorized', { method: 'DELETE' });
                if (res.ok) updateDashboard();
            }
        }

        async function clearAllLogs() {
            if (confirm('T√úM log ge√ßmi≈üini silmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz!')) {
                const res = await fetch('/admin/logs/all', { method: 'DELETE' });
                if (res.ok) updateDashboard();
            }
        }

        // Initial traffic chart (Placeholder)
        const ctx = document.getElementById('trafficChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'],
                datasets: [{
                    label: 'Giri≈ü Sayƒ±sƒ±',
                    data: [2, 1, 8, 15, 12, 10],
                    borderColor: '#4facfe',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(79, 172, 254, 0.1)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Auto update every 5 seconds
        updateDashboard();
        setInterval(updateDashboard, 5000);
    </script>
</body>
</html>
